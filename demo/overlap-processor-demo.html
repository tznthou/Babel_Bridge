<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OverlapProcessor æ¸¬è©¦ Demo - Babel Bridge</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .content {
      padding: 30px;
    }

    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .test-section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .test-section p {
      color: #666;
      margin-bottom: 15px;
      line-height: 1.6;
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    button:active {
      transform: translateY(0);
    }

    button.secondary {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    button.clear {
      background: #6c757d;
    }

    .output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .result-item {
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid transparent;
    }

    .result-item.success {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }

    .result-item.error {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }

    .result-item.info {
      background: #d1ecf1;
      border-left-color: #17a2b8;
      color: #0c5460;
    }

    .result-item strong {
      display: block;
      margin-bottom: 8px;
      font-size: 1.1em;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      text-align: center;
    }

    .stat-card .number {
      font-size: 2em;
      font-weight: bold;
      color: #667eea;
    }

    .stat-card .label {
      color: #666;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .code-block {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 12px;
      overflow-x: auto;
      margin: 10px 0;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge.success { background: #28a745; color: white; }
    .badge.error { background: #dc3545; color: white; }
    .badge.warning { background: #ffc107; color: #333; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“ OverlapProcessor æ¸¬è©¦ Demo</h1>
      <p>Babel Bridge - éŸ³è¨Šæ®µé‡ç–Šè™•ç†èˆ‡æ–·å¥å„ªåŒ–</p>
    </div>

    <div class="content">
      <!-- æ¸¬è©¦å€å¡Š 1: åŸºç¤åŠŸèƒ½ -->
      <div class="test-section">
        <h2>ğŸ”§ æ¸¬è©¦ 1: åŸºç¤åŠŸèƒ½</h2>
        <p>æ¸¬è©¦ OverlapProcessor çš„åŸºæœ¬åˆå§‹åŒ–èˆ‡å–®æ®µéŸ³è¨Šè™•ç†</p>
        <div class="controls">
          <button onclick="runTest1()">åŸ·è¡Œæ¸¬è©¦</button>
        </div>
        <div id="output1" class="output"></div>
      </div>

      <!-- æ¸¬è©¦å€å¡Š 2: é‡ç–Šå€å»é‡ -->
      <div class="test-section">
        <h2>ğŸ”„ æ¸¬è©¦ 2: é‡ç–Šå€å»é‡</h2>
        <p>æ¸¬è©¦ä¸‰æ®µé€£çºŒéŸ³è¨Šçš„é‡ç–Šå€åŸŸå»é‡åŠŸèƒ½ï¼ˆRolling Window ç­–ç•¥ï¼‰</p>
        <div class="controls">
          <button onclick="runTest2()">åŸ·è¡Œæ¸¬è©¦</button>
        </div>
        <div id="output2" class="output"></div>
      </div>

      <!-- æ¸¬è©¦å€å¡Š 3: å¥å­åˆä½µ -->
      <div class="test-section">
        <h2>ğŸ“ æ¸¬è©¦ 3: å¥å­åˆä½µ</h2>
        <p>æ¸¬è©¦å¤šèªè¨€æ–·å¥è¦å‰‡èˆ‡ç ´ç¢å¥å­åˆä½µåŠŸèƒ½</p>
        <div class="controls">
          <button onclick="runTest3()">åŸ·è¡Œæ¸¬è©¦</button>
        </div>
        <div id="output3" class="output"></div>
      </div>

      <!-- æ¸¬è©¦å€å¡Š 4: æ–‡å­—ç›¸ä¼¼åº¦ -->
      <div class="test-section">
        <h2>ğŸ¯ æ¸¬è©¦ 4: æ–‡å­—ç›¸ä¼¼åº¦è¨ˆç®—</h2>
        <p>æ¸¬è©¦ Levenshtein Distance æ¼”ç®—æ³•èˆ‡ç›¸ä¼¼åº¦è¨ˆç®—</p>
        <div class="controls">
          <button onclick="runTest4()">åŸ·è¡Œæ¸¬è©¦</button>
        </div>
        <div id="output4" class="output"></div>
      </div>

      <!-- æ¸¬è©¦å€å¡Š 5: å­—å¹•æ™‚é–“åŒæ­¥ -->
      <div class="test-section">
        <h2>â±ï¸ æ¸¬è©¦ 5: å­—å¹•æ™‚é–“åŒæ­¥</h2>
        <p>æ¸¬è©¦ Content Script çš„ Video ç›£è½èˆ‡å­—å¹•åŒæ­¥é¡¯ç¤º</p>
        <div class="controls">
          <button onclick="initSyncTest()">åˆå§‹åŒ–æ¸¬è©¦</button>
          <button onclick="loadTestSubtitles()" class="secondary">è¼‰å…¥æ¸¬è©¦å­—å¹•</button>
          <button onclick="clearTestSubtitles()" class="clear">æ¸…é™¤å­—å¹•</button>
        </div>
        <div style="margin-top: 15px; background: #f0f0f0; padding: 15px; border-radius: 8px;">
          <video id="testVideo" controls style="width: 100%; border-radius: 6px; background: #000;">
            <source src="https://www.w3schools.com/html/mov_bbb.mp4" type="video/mp4">
          </video>
          <div id="babel-subtitle-overlay" style="position: relative; margin-top: -60px; text-align: center; display: none; pointer-events: none;">
            <div id="babel-subtitle" style="display: inline-block; background: rgba(0,0,0,0.85); color: white; padding: 10px 20px; border-radius: 6px; font-size: 18px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></div>
          </div>
        </div>
        <div id="output5" class="output"></div>
      </div>

      <!-- å…¨éƒ¨æ¸¬è©¦ -->
      <div class="test-section">
        <h2>ğŸš€ Phase 1 å®Œæ•´æ¸¬è©¦å¥—ä»¶</h2>
        <p>åŸ·è¡Œæ‰€æœ‰æ ¸å¿ƒæ¼”ç®—æ³•æ¸¬è©¦ä¸¦é¡¯ç¤ºçµ±è¨ˆçµæœï¼ˆæ¸¬è©¦ 1-4ï¼‰</p>
        <div class="controls">
          <button onclick="runAllCoreTests()">ğŸ¯ ä¸€éµåŸ·è¡Œå®Œæ•´æ¸¬è©¦</button>
          <button class="clear" onclick="clearAllOutputs()">æ¸…é™¤æ‰€æœ‰è¼¸å‡º</button>
        </div>
        <div id="stats" class="stats" style="display: none;"></div>
        <div id="finalResult" style="margin-top: 20px; display: none;"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { OverlapProcessor } from '../src/background/subtitle-processor.js'
    import { calculateSimilarity, levenshteinDistance, normalizeText } from '../src/lib/text-similarity.js'
    import { LanguageRules } from '../src/lib/language-rules.js'

    // å…¨åŸŸè®Šæ•¸
    window.OverlapProcessor = OverlapProcessor
    window.calculateSimilarity = calculateSimilarity
    window.levenshteinDistance = levenshteinDistance
    window.normalizeText = normalizeText
    window.LanguageRules = LanguageRules

    let testResults = {
      passed: 0,
      failed: 0,
      total: 0
    }

    // æ¸¬è©¦ 1: åŸºç¤åŠŸèƒ½
    window.runTest1 = function() {
      const output = document.getElementById('output1')
      output.innerHTML = ''

      const log = (msg, color = '#d4d4d4') => {
        output.innerHTML += `<span style="color: ${color};">${msg}</span>\n`
      }

      try {
        log('ğŸ”§ é–‹å§‹æ¸¬è©¦åŸºç¤åŠŸèƒ½\n', '#4caf50')

        // åˆå§‹åŒ–
        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ“¦ æ­¥é©Ÿ 1: åˆå§‹åŒ– OverlapProcessor', '#ff9800')
        const processor = new OverlapProcessor({ debug: false })
        log('   é…ç½®:', '#aaa')
        log(`     - é‡ç–Šæ™‚é•·: ${processor.config.overlapDuration}ms`, '#ccc')
        log(`     - ç›¸ä¼¼åº¦é–¾å€¼: ${processor.config.similarityThreshold}`, '#ccc')
        log(`     - åˆä½µæ™‚é–“é–“éš”: ${processor.config.mergeTimeGap}s`, '#ccc')
        log('   âœ… åˆå§‹åŒ–æˆåŠŸ\n', '#4caf50')

        // è™•ç†ç¬¬ä¸€æ®µéŸ³è¨Š
        const chunk1 = {
          text: 'Hello world',
          segments: [
            { id: 0, start: 0.0, end: 2.0, text: 'Hello world' }
          ]
        }

        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ¬ æ­¥é©Ÿ 2: è™•ç†ç¬¬ä¸€æ®µéŸ³è¨Š (0.0s)', '#ff9800')
        log('   è¼¸å…¥:', '#aaa')
        log(`     - Segments æ•¸é‡: ${chunk1.segments.length}`, '#ccc')
        log(`     - æ–‡å­—: "${chunk1.segments[0].text}"`, '#ccc')
        log(`     - æ™‚é–“ç¯„åœ: ${chunk1.segments[0].start}s - ${chunk1.segments[0].end}s`, '#ccc')

        const result = processor.process(chunk1, 0.0)

        log('   è™•ç†çµæœ:', '#aaa')
        log(`     - è¼¸å‡º Segments: ${result.length}`, '#4caf50')
        log(`     - æ–‡å­—: "${result[0].text}"`, '#4caf50')
        log(`     - çµ•å°æ™‚é–“: ${result[0].start.toFixed(1)}s - ${result[0].end.toFixed(1)}s`, '#4caf50')
        log('   âœ… ç¬¬ä¸€æ®µéŸ³è¨Šè™•ç†å®Œæˆ\n', '#4caf50')

        // é©—è­‰ç‹€æ…‹
        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ” æ­¥é©Ÿ 3: é©—è­‰å…§éƒ¨ç‹€æ…‹', '#ff9800')
        log(`   previousSegments: ${processor.previousSegments ? processor.previousSegments.length : 0} å€‹`, '#ccc')
        log(`   processedSegments: ${processor.processedSegments.length} å€‹`, '#ccc')
        log(`   chunkCount: ${processor.chunkCount}`, '#ccc')

        // æœ€çµ‚åˆ¤å®š
        const passed = result.length === 1 &&
                      result[0].text === 'Hello world' &&
                      result[0].start === 0.0 &&
                      result[0].end === 2.0 &&
                      processor.previousSegments !== null

        log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ“Š æ¸¬è©¦çµæœ:', '#ff9800')
        log(`   Segment æ•¸é‡: ${result.length === 1 ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'}`, result.length === 1 ? '#4caf50' : '#f44336')
        log(`   æ–‡å­—å…§å®¹: ${result[0].text === 'Hello world' ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'}`, result[0].text === 'Hello world' ? '#4caf50' : '#f44336')
        log(`   æ™‚é–“æˆ³èª¿æ•´: ${result[0].start === 0.0 && result[0].end === 2.0 ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'}`, result[0].start === 0.0 && result[0].end === 2.0 ? '#4caf50' : '#f44336')
        log(`   ç‹€æ…‹ä¿å­˜: ${processor.previousSegments !== null ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'}`, processor.previousSegments !== null ? '#4caf50' : '#f44336')

        if (passed) {
          log('\nâœ… åŸºç¤åŠŸèƒ½æ¸¬è©¦é€šéï¼', '#4caf50')
          testResults.passed++
        } else {
          log('\nâŒ åŸºç¤åŠŸèƒ½æ¸¬è©¦å¤±æ•—', '#f44336')
          testResults.failed++
        }
        testResults.total++

      } catch (error) {
        log(`âŒ éŒ¯èª¤: ${error.message}`, '#f44336')
        log(error.stack, '#f44336')
        testResults.failed++
        testResults.total++
      }
    }

    // æ¸¬è©¦ 2: é‡ç–Šå€å»é‡
    window.runTest2 = function() {
      const output = document.getElementById('output2')
      output.innerHTML = ''

      const log = (msg, color = '#d4d4d4') => {
        output.innerHTML += `<span style="color: ${color};">${msg}</span>\n`
      }

      try {
        const processor = new OverlapProcessor({ debug: false })

        log('ğŸ“Š é–‹å§‹æ¸¬è©¦ä¸‰æ®µé€£çºŒéŸ³è¨Šçš„å»é‡è™•ç†\n', '#4caf50')

        // Chunk 1: 0-3s
        const chunk1 = {
          segments: [
            { id: 0, start: 0.0, end: 2.0, text: 'ä»Šå¤©å¤©æ°£å¾ˆå¥½' },
            { id: 1, start: 2.0, end: 3.0, text: 'æˆ‘å€‘å»å…¬åœ’' }
          ]
        }

        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ¬ Chunk 1: éŸ³è¨Š 0.0s - 3.0s', '#ff9800')
        log('   è¼¸å…¥ segments:', '#aaa')
        chunk1.segments.forEach(s => {
          log(`     - [${s.start.toFixed(1)}s-${s.end.toFixed(1)}s] "${s.text}"`, '#ccc')
        })

        const result1 = processor.process(chunk1, 0.0)
        log(`   âœ… è™•ç†çµæœ: ${result1.length} å€‹ segments (ç¬¬ä¸€æ®µï¼Œå…¨éƒ¨ä¿ç•™)\n`, '#4caf50')

        // Chunk 2: 2-5s (é‡ç–Š 2-3s)
        const chunk2 = {
          segments: [
            { id: 0, start: 0.0, end: 1.0, text: 'æˆ‘å€‘å»å…¬åœ’' },  // é‡è¤‡
            { id: 1, start: 1.0, end: 3.0, text: 'ç©éŠæˆ²' }
          ]
        }

        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ¬ Chunk 2: éŸ³è¨Š 2.0s - 5.0s (é‡ç–Šå€ 2.0s-3.0s)', '#ff9800')
        log('   è¼¸å…¥ segments:', '#aaa')
        chunk2.segments.forEach(s => {
          const absStart = s.start + 2.0
          const absEnd = s.end + 2.0
          log(`     - [${absStart.toFixed(1)}s-${absEnd.toFixed(1)}s] "${s.text}"`, '#ccc')
        })

        const result2 = processor.process(chunk2, 2.0)
        log(`   ğŸ” é‡ç–Šå€åˆ†æ: ç™¼ç¾ "${chunk2.segments[0].text}" èˆ‡å‰ä¸€æ®µé‡è¤‡`, '#ffc107')
        log(`   âœ… å»é‡çµæœ: ${result2.length} å€‹ segments (éæ¿¾æ‰ ${chunk2.segments.length - result2.length} å€‹é‡è¤‡)\n`, '#4caf50')

        // Chunk 3: 4-7s (é‡ç–Š 4-5s)
        const chunk3 = {
          segments: [
            { id: 0, start: 0.0, end: 1.0, text: 'ç©éŠæˆ²' },  // é‡è¤‡
            { id: 1, start: 1.0, end: 3.0, text: 'ç„¶å¾Œå›å®¶' }
          ]
        }

        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ¬ Chunk 3: éŸ³è¨Š 4.0s - 7.0s (é‡ç–Šå€ 4.0s-5.0s)', '#ff9800')
        log('   è¼¸å…¥ segments:', '#aaa')
        chunk3.segments.forEach(s => {
          const absStart = s.start + 4.0
          const absEnd = s.end + 4.0
          log(`     - [${absStart.toFixed(1)}s-${absEnd.toFixed(1)}s] "${s.text}"`, '#ccc')
        })

        const result3 = processor.process(chunk3, 4.0)
        log(`   ğŸ” é‡ç–Šå€åˆ†æ: ç™¼ç¾ "${chunk3.segments[0].text}" èˆ‡å‰ä¸€æ®µé‡è¤‡`, '#ffc107')
        log(`   âœ… å»é‡çµæœ: ${result3.length} å€‹ segments (éæ¿¾æ‰ ${chunk3.segments.length - result3.length} å€‹é‡è¤‡)\n`, '#4caf50')

        // æœ€çµ‚çµæœ
        const allSegments = processor.getAllSegments()
        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ“‹ æœ€çµ‚å®Œæ•´å­—å¹• (å·²å»é‡):', '#4caf50')

        // æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡
        const texts = allSegments.map(s => s.text)
        const uniqueTexts = new Set(texts)
        const hasDuplicates = texts.length !== uniqueTexts.size

        allSegments.forEach((seg, idx) => {
          log(`   ${idx + 1}. [${seg.start.toFixed(1)}s-${seg.end.toFixed(1)}s] "${seg.text}"`, '#4caf50')
        })

        log('', '')
        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ“Š çµ±è¨ˆçµæœ:', '#ff9800')
        log(`   ç¸½ segments: ${allSegments.length}`, '#ccc')
        log(`   å”¯ä¸€æ–‡å­—: ${uniqueTexts.size}`, '#ccc')
        log(`   æœ‰é‡è¤‡: ${hasDuplicates ? 'æ˜¯' : 'å¦'}`, hasDuplicates ? '#f44336' : '#4caf50')

        if (!hasDuplicates) {
          log('\nâœ… æ¸¬è©¦é€šéï¼å»é‡åŠŸèƒ½æ­£å¸¸é‹ä½œ', '#4caf50')
          testResults.passed++
        } else {
          log('\nâŒ æ¸¬è©¦å¤±æ•—ï¼šç™¼ç¾é‡è¤‡å…§å®¹', '#f44336')
          testResults.failed++
        }
        testResults.total++

      } catch (error) {
        log(`âŒ éŒ¯èª¤: ${error.message}`, '#f44336')
        testResults.failed++
        testResults.total++
      }
    }

    // ç§»é™¤è©³ç´°æ¨¡å¼ï¼ˆå·²æ•´åˆåˆ°ä¸»æ¸¬è©¦ä¸­ï¼‰
    window.runTest2Detailed = window.runTest2

    // æ¸¬è©¦ 3: å¥å­åˆä½µ
    window.runTest3 = function() {
      const output = document.getElementById('output3')
      output.innerHTML = ''

      const log = (msg, color = '#d4d4d4') => {
        output.innerHTML += `<span style="color: ${color};">${msg}</span>\n`
      }

      try {
        const processor = new OverlapProcessor({ debug: false })

        log('ğŸ“ é–‹å§‹æ¸¬è©¦å¤šèªè¨€æ–·å¥èˆ‡åˆä½µ\n', '#4caf50')

        // ä¸­æ–‡æ¸¬è©¦
        const zhSegments = [
          { start: 0.0, end: 1.0, text: 'ä»Šå¤©å¤©æ°£ï¼Œ' },
          { start: 1.0, end: 2.0, text: 'å¾ˆå¥½' },
          { start: 2.5, end: 3.5, text: 'æˆ‘å€‘å»å…¬åœ’ã€‚' }
        ]

        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ‡¹ğŸ‡¼ ä¸­æ–‡æ¸¬è©¦ (zh-TW)', '#ff9800')
        log('   åŸå§‹ segments:', '#aaa')
        zhSegments.forEach((s, i) => {
          log(`     ${i + 1}. "${s.text}"`, '#ccc')
        })

        const zhMerged = processor.mergeBrokenSentences(zhSegments, 'zh-TW')
        log('   åˆä½µçµæœ:', '#aaa')
        zhMerged.forEach((seg, idx) => {
          log(`     ${idx + 1}. "${seg.text}" [${seg.start.toFixed(1)}s-${seg.end.toFixed(1)}s]`, '#4caf50')
        })
        log(`   åŸå§‹: ${zhSegments.length} â†’ åˆä½µå¾Œ: ${zhMerged.length}\n`, '#ffc107')

        // è‹±æ–‡æ¸¬è©¦
        const enSegments = [
          { start: 0.0, end: 1.0, text: 'The weather is good,' },
          { start: 1.0, end: 2.0, text: 'today' },
          { start: 2.5, end: 3.5, text: 'We go to park.' }
        ]

        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ‡ºğŸ‡¸ è‹±æ–‡æ¸¬è©¦ (en)', '#ff9800')
        log('   åŸå§‹ segments:', '#aaa')
        enSegments.forEach((s, i) => {
          log(`     ${i + 1}. "${s.text}"`, '#ccc')
        })

        const enMerged = processor.mergeBrokenSentences(enSegments, 'en')
        log('   åˆä½µçµæœ:', '#aaa')
        enMerged.forEach((seg, idx) => {
          log(`     ${idx + 1}. "${seg.text}" [${seg.start.toFixed(1)}s-${seg.end.toFixed(1)}s]`, '#4caf50')
        })
        log(`   åŸå§‹: ${enSegments.length} â†’ åˆä½µå¾Œ: ${enMerged.length}\n`, '#ffc107')

        const expectedZh = zhMerged.length === 2  // "ä»Šå¤©å¤©æ°£ï¼Œå¾ˆå¥½" + "æˆ‘å€‘å»å…¬åœ’ã€‚"
        const expectedEn = enMerged.length === 2  // "The weather is good, today" + "We go to park."

        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ“Š æ¸¬è©¦çµæœ:', '#ff9800')
        log(`   ä¸­æ–‡åˆä½µ: ${expectedZh ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'}`, expectedZh ? '#4caf50' : '#f44336')
        log(`   è‹±æ–‡åˆä½µ: ${expectedEn ? 'âœ… æ­£ç¢º' : 'âŒ éŒ¯èª¤'}`, expectedEn ? '#4caf50' : '#f44336')

        if (expectedZh && expectedEn) {
          log('\nâœ… å¥å­åˆä½µæ¸¬è©¦é€šéï¼', '#4caf50')
          testResults.passed++
        } else {
          log('\nâŒ å¥å­åˆä½µæ¸¬è©¦å¤±æ•—', '#f44336')
          testResults.failed++
        }
        testResults.total++

      } catch (error) {
        log(`âŒ éŒ¯èª¤: ${error.message}`, '#f44336')
        testResults.failed++
        testResults.total++
      }
    }

    // æ¸¬è©¦ 4: æ–‡å­—ç›¸ä¼¼åº¦
    window.runTest4 = function() {
      const output = document.getElementById('output4')
      output.innerHTML = ''

      const log = (msg, color = '#d4d4d4') => {
        output.innerHTML += `<span style="color: ${color};">${msg}</span>\n`
      }

      try {
        log('ğŸ¯ é–‹å§‹æ¸¬è©¦æ–‡å­—ç›¸ä¼¼åº¦æ¼”ç®—æ³•\n', '#4caf50')

        // Levenshtein Distance æ¸¬è©¦
        const tests = [
          { str1: 'hello', str2: 'hello', expected: 0, name: 'å®Œå…¨ç›¸åŒ' },
          { str1: 'kitten', str2: 'sitting', expected: 3, name: 'å¤šé‡æ“ä½œ' },
          { str1: 'abc', str2: 'xyz', expected: 3, name: 'å®Œå…¨ä¸åŒ' },
        ]

        log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ“ Levenshtein Distance (ç·¨è¼¯è·é›¢)', '#ff9800')
        let allPassed = true

        tests.forEach(test => {
          const result = levenshteinDistance(test.str1, test.str2)
          const passed = result === test.expected
          const icon = passed ? 'âœ…' : 'âŒ'
          const color = passed ? '#4caf50' : '#f44336'
          log(`   ${icon} ${test.name}:`, color)
          log(`      "${test.str1}" â†’ "${test.str2}"`, '#ccc')
          log(`      ç·¨è¼¯è·é›¢: ${result} (æœŸæœ›: ${test.expected})`, color)
          if (!passed) allPassed = false
        })

        // ç›¸ä¼¼åº¦è¨ˆç®—æ¸¬è©¦
        log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ“Š ç›¸ä¼¼åº¦è¨ˆç®— (0-1 ç¯„åœ)', '#ff9800')

        const simTests = [
          { str1: 'hello', str2: 'hello', name: 'å®Œå…¨ç›¸åŒ', expectedMin: 1.0 },
          { str1: 'Hello, World!', str2: 'hello world', name: 'å¿½ç•¥æ¨™é»å¤§å°å¯«', expectedMin: 1.0 },
          { str1: 'abc', str2: 'xyz', name: 'å®Œå…¨ä¸åŒ', expectedMax: 0.3 },
          { str1: 'ä»Šå¤©å¤©æ°£å¾ˆå¥½', str2: 'ä»Šå¤©å¤©æ°£å¥½å¥½', name: 'è¼•å¾®å·®ç•°', expectedMin: 0.8 }
        ]

        let simPassed = true
        simTests.forEach(test => {
          const sim = calculateSimilarity(test.str1, test.str2)
          const simPercent = (sim * 100).toFixed(1)

          let passed
          if (test.expectedMin !== undefined) {
            passed = sim >= test.expectedMin
          } else {
            passed = sim <= test.expectedMax
          }

          const icon = passed ? 'âœ…' : 'âŒ'
          const color = passed ? '#4caf50' : '#f44336'

          log(`   ${icon} ${test.name}:`, color)
          log(`      "${test.str1}"`, '#ccc')
          log(`      "${test.str2}"`, '#ccc')
          log(`      ç›¸ä¼¼åº¦: ${simPercent}%`, color)

          if (!passed) simPassed = false
        })

        log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
        log('ğŸ“Š æ¸¬è©¦çµæœ:', '#ff9800')
        log(`   ç·¨è¼¯è·é›¢: ${allPassed ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}`, allPassed ? '#4caf50' : '#f44336')
        log(`   ç›¸ä¼¼åº¦è¨ˆç®—: ${simPassed ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}`, simPassed ? '#4caf50' : '#f44336')

        if (allPassed && simPassed) {
          log('\nâœ… æ–‡å­—ç›¸ä¼¼åº¦æ¸¬è©¦é€šéï¼', '#4caf50')
          testResults.passed++
        } else {
          log('\nâŒ æ–‡å­—ç›¸ä¼¼åº¦æ¸¬è©¦å¤±æ•—', '#f44336')
          testResults.failed++
        }
        testResults.total++

      } catch (error) {
        log(`âŒ éŒ¯èª¤: ${error.message}`, '#f44336')
        testResults.failed++
        testResults.total++
      }
    }

    // æ¸¬è©¦ 5: å­—å¹•æ™‚é–“åŒæ­¥
    let syncTestOverlay = null

    window.initSyncTest = function() {
      const output = document.getElementById('output5')
      output.innerHTML = ''

      const log = (msg, color = '#d4d4d4') => {
        output.innerHTML += `<span style="color: ${color};">${msg}</span>\n`
      }

      try {
        log('ğŸ”§ é–‹å§‹åˆå§‹åŒ–å­—å¹•æ™‚é–“åŒæ­¥æ¸¬è©¦\n', '#4caf50')

        // ç°¡åŒ–ç‰ˆçš„ VideoMonitor èˆ‡ SubtitleOverlay
        class VideoMonitor {
          constructor(videoEl, onTimeUpdate) {
            this.videoElement = videoEl
            this.onTimeUpdate = onTimeUpdate
            this.attach()
          }

          attach() {
            this.videoElement.addEventListener('timeupdate', () => {
              if (this.onTimeUpdate) {
                this.onTimeUpdate(this.videoElement.currentTime)
              }
            })
            log('âœ… å·²é™„åŠ åˆ° video å…ƒç´ ', '#4caf50')
          }

          getCurrentTime() {
            return this.videoElement.currentTime
          }
        }

        class SubtitleOverlay {
          constructor(videoEl, containerEl, subtitleEl) {
            this.container = containerEl
            this.subtitleEl = subtitleEl
            this.segments = []
            this.currentSegmentIndex = -1
            this.videoMonitor = new VideoMonitor(videoEl, this.handleTimeUpdate.bind(this))
          }

          addSubtitleData(data) {
            if (!data.segments || data.segments.length === 0) return

            log(`ğŸ“¥ æ¥æ”¶ ${data.segments.length} å€‹ segments`, '#4caf50')
            this.segments.push(...data.segments)
            this.segments.sort((a, b) => a.start - b.start)
            log(`ğŸ“Š ç›®å‰ç¸½å…±æœ‰ ${this.segments.length} å€‹ segments`, '#4caf50')

            this.updateDisplay(this.videoMonitor.getCurrentTime())
          }

          handleTimeUpdate(currentTime) {
            this.updateDisplay(currentTime)
          }

          updateDisplay(currentTime) {
            const segmentIndex = this.findSegmentIndex(currentTime)

            if (segmentIndex === -1) {
              this.hide()
              return
            }

            if (segmentIndex === this.currentSegmentIndex) {
              return
            }

            this.currentSegmentIndex = segmentIndex
            this.show(this.segments[segmentIndex])
          }

          findSegmentIndex(currentTime) {
            for (let i = 0; i < this.segments.length; i++) {
              const segment = this.segments[i]
              if (currentTime >= segment.start && currentTime <= segment.end) {
                return i
              }
            }
            return -1
          }

          show(segment) {
            this.subtitleEl.textContent = segment.text
            this.container.style.display = 'block'
            log(`ğŸ’¬ é¡¯ç¤º: "${segment.text}" (${segment.start.toFixed(2)}s - ${segment.end.toFixed(2)}s)`, '#4caf50')
          }

          hide() {
            if (this.container.style.display !== 'none') {
              this.container.style.display = 'none'
              this.currentSegmentIndex = -1
            }
          }

          clear() {
            this.container.style.display = 'none'
            this.subtitleEl.textContent = ''
            this.segments = []
            this.currentSegmentIndex = -1
            log('ğŸ—‘ï¸ å·²æ¸…é™¤æ‰€æœ‰å­—å¹•', '#ff9800')
          }
        }

        const videoEl = document.getElementById('testVideo')
        const containerEl = document.getElementById('babel-subtitle-overlay')
        const subtitleEl = document.getElementById('babel-subtitle')

        syncTestOverlay = new SubtitleOverlay(videoEl, containerEl, subtitleEl)

        log('\nâœ… å­—å¹•æ™‚é–“åŒæ­¥æ¸¬è©¦åˆå§‹åŒ–å®Œæˆï¼', '#4caf50')
        log('ğŸ“Œ è«‹é»æ“Šã€Œè¼‰å…¥æ¸¬è©¦å­—å¹•ã€æŒ‰éˆ•æ¸¬è©¦', '#ff9800')

      } catch (error) {
        log(`âŒ éŒ¯èª¤: ${error.message}`, '#f44336')
        log(error.stack, '#f44336')
      }
    }

    window.loadTestSubtitles = function() {
      if (!syncTestOverlay) {
        alert('è«‹å…ˆé»æ“Šã€Œåˆå§‹åŒ–æ¸¬è©¦ã€æŒ‰éˆ•')
        return
      }

      const output = document.getElementById('output5')
      const log = (msg, color = '#d4d4d4') => {
        output.innerHTML += `<span style="color: ${color};">${msg}</span>\n`
      }

      const testData = {
        chunkIndex: 0,
        startTime: 0,
        endTime: 20,
        segments: [
          { id: 0, start: 0.0, end: 2.5, text: 'Hello, this is the first subtitle.' },
          { id: 1, start: 2.5, end: 5.0, text: 'Now we are showing the second one.' },
          { id: 2, start: 5.0, end: 7.5, text: 'And here comes the third subtitle.' },
          { id: 3, start: 7.5, end: 10.0, text: 'Almost done with the fourth.' },
          { id: 4, start: 10.0, end: 12.5, text: 'This is the final subtitle segment.' },
          { id: 5, start: 12.5, end: 15.0, text: 'Wait, one more for good measure!' },
          { id: 6, start: 15.0, end: 17.5, text: 'Okay, now we are really done.' },
          { id: 7, start: 17.5, end: 20.0, text: 'The very last subtitle. Goodbye!' }
        ],
        language: 'en'
      }

      log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', '#666')
      syncTestOverlay.addSubtitleData(testData)
      log('âœ… æ¸¬è©¦å­—å¹•å·²è¼‰å…¥ï¼Œè«‹æ’­æ”¾å½±ç‰‡è§€å¯Ÿå­—å¹•åŒæ­¥\n', '#4caf50')
    }

    window.clearTestSubtitles = function() {
      if (!syncTestOverlay) {
        alert('è«‹å…ˆé»æ“Šã€Œåˆå§‹åŒ–æ¸¬è©¦ã€æŒ‰éˆ•')
        return
      }

      syncTestOverlay.clear()
    }

    // åŸ·è¡Œæ‰€æœ‰æ ¸å¿ƒæ¸¬è©¦ (æ¸¬è©¦ 1-4)
    window.runAllCoreTests = function() {
      testResults = { passed: 0, failed: 0, total: 0 }

      // æ¸…ç©ºä¹‹å‰çš„è¼¸å‡º
      clearAllOutputs()

      console.log('ğŸš€ é–‹å§‹åŸ·è¡Œ Phase 1 å®Œæ•´æ¸¬è©¦å¥—ä»¶...')

      runTest1()
      setTimeout(() => runTest2(), 100)
      setTimeout(() => runTest3(), 200)
      setTimeout(() => runTest4(), 300)

      setTimeout(() => {
        const stats = document.getElementById('stats')
        const finalResult = document.getElementById('finalResult')

        stats.style.display = 'grid'
        finalResult.style.display = 'block'

        const passRate = testResults.total > 0 ? ((testResults.passed / testResults.total) * 100).toFixed(0) : 0
        const allPassed = testResults.passed === testResults.total

        stats.innerHTML = `
          <div class="stat-card">
            <div class="number" style="color: #4caf50;">${testResults.passed}</div>
            <div class="label">é€šé</div>
          </div>
          <div class="stat-card">
            <div class="number" style="color: #f44336;">${testResults.failed}</div>
            <div class="label">å¤±æ•—</div>
          </div>
          <div class="stat-card">
            <div class="number" style="color: #667eea;">${testResults.total}</div>
            <div class="label">ç¸½è¨ˆ</div>
          </div>
          <div class="stat-card">
            <div class="number" style="color: #ff9800;">${passRate}%</div>
            <div class="label">é€šéç‡</div>
          </div>
        `

        // æœ€çµ‚åˆ¤å®š
        if (allPassed) {
          finalResult.innerHTML = `
            <div style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #28a745;">
              <h3 style="color: #155724; margin: 0 0 10px 0;">âœ… æ‰€æœ‰æ ¸å¿ƒæ¼”ç®—æ³•æ¸¬è©¦é€šéï¼</h3>
              <p style="color: #155724; margin: 0; line-height: 1.6;">
                ğŸ‰ æ­å–œï¼æ‰€æœ‰æ¸¬è©¦ (${testResults.total}/${testResults.total}) éƒ½æˆåŠŸé€šéã€‚<br>
                ğŸ“‹ <strong>ä¸‹ä¸€æ­¥</strong>: è«‹ç¹¼çºŒé€²è¡Œã€Œå¯¦éš› Extension æ¸¬è©¦ã€ï¼Œé©—è­‰å®Œæ•´éŸ³è¨Šè™•ç†ç®¡ç·šã€‚<br>
                ğŸ“– åƒè€ƒæ–‡ä»¶: <code>TESTING_PHASE1.md</code> Â§ éšæ®µ 2-7
              </p>
            </div>
          `
          console.log('âœ… Phase 1 æ ¸å¿ƒæ¸¬è©¦å…¨éƒ¨é€šéï¼')
        } else {
          finalResult.innerHTML = `
            <div style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545;">
              <h3 style="color: #721c24; margin: 0 0 10px 0;">âŒ æ¸¬è©¦æœªå…¨éƒ¨é€šé</h3>
              <p style="color: #721c24; margin: 0; line-height: 1.6;">
                é€šé: ${testResults.passed}/${testResults.total} (${passRate}%)<br>
                å¤±æ•—: ${testResults.failed} å€‹æ¸¬è©¦<br>
                è«‹æª¢æŸ¥ä¸Šæ–¹ç´…è‰²æ¨™è¨˜çš„æ¸¬è©¦é …ç›®ï¼Œä¿®å¾©å•é¡Œå¾Œé‡æ–°æ¸¬è©¦ã€‚
              </p>
            </div>
          `
          console.error(`âŒ æœ‰ ${testResults.failed} å€‹æ¸¬è©¦å¤±æ•—`)
        }
      }, 500)
    }

    // ä¿ç•™èˆŠå‡½æ•¸åç¨±å‘å¾Œç›¸å®¹
    window.runAllTests = window.runAllCoreTests

    // æ¸…é™¤æ‰€æœ‰è¼¸å‡º
    window.clearAllOutputs = function() {
      document.getElementById('output1').innerHTML = ''
      document.getElementById('output2').innerHTML = ''
      document.getElementById('output3').innerHTML = ''
      document.getElementById('output4').innerHTML = ''
      document.getElementById('output5').innerHTML = ''
      document.getElementById('stats').style.display = 'none'
      testResults = { passed: 0, failed: 0, total: 0 }
    }

    console.log('âœ… OverlapProcessor Demo è¼‰å…¥å®Œæˆ')
    console.log('å¯ç”¨çš„å…¨åŸŸå‡½æ•¸: runTest1, runTest2, runTest3, runTest4, initSyncTest, runAllTests')
  </script>
</body>
</html>
